{
  "name": "Puppet Ramp Up Program Control-Repo",
  "tagline": "An opinionated control repository and steps for setting it up in PE",
  "body": "Table of contents\r\n=================\r\n\r\n* [Join the \\#ramp\\-up channel on Puppet Community Slack](#join-the-ramp-up-channel-on-puppet-community-slack)\r\n* [Before starting](#before-starting)\r\n* [What you get from this control\\-repo](#what-you-get-from-this-control-repo)\r\n* [How to set it all up](#how-to-set-it-all-up)\r\n  * [Copy this repo into your own Git server](#copy-this-repo-into-your-own-git-server)\r\n    * [GitLab](#gitlab)\r\n    * [Stash](#stash)\r\n    * [GitHub](#github)\r\n  * [Configure PE to use the control\\-repo](#configure-pe-to-use-the-control-repo)\r\n    * [Install PE](#install-pe)\r\n    * [Get the control\\-repo deployed on your master](#get-the-control-repo-deployed-on-your-master)\r\n  * [Setup a webhook in your Git server](#setup-a-webhook-in-your-git-server)\r\n    * [Gitlab](#gitlab-1)\r\n  * [Test Code Manager](#test-code-manager)\r\n\r\n# Join the #ramp-up channel on Puppet Community Slack\r\n\r\nOur [Puppet Community Slack](http://slack.puppet.com) is a great way to interact with other Puppet users.  The #ramp-up channel is specifically for users who are new to Puppet Enterprise and using this repository. Other channels in the Puppet Community Slack are great for asking general Puppet questions.\r\n\r\n# Before starting\r\n\r\nThis control-repo and the steps below are intended to be used with a new installation of PE 2016.1.z.\r\n\r\n**Warning:** When using an existing PE installation any existing code or modules in `/etc/puppetlabs/code` will be copied to a backup directory `/etc/puppetlabs/code_bak_<timestamp>` in order to allow deploying code from code manager.\r\n\r\n# What you get from this control-repo\r\n\r\nWhen you finish the instructions below, you will have the beginning of a best practices installation of PE including:\r\n\r\n - A Git server\r\n - The ability to push code to your Git server and have it automatically deployed to your PE master\r\n - A config_version script that outputs the most recent SHA of your code each time you run `puppet agent -t`\r\n - Optimal tuning of PE settings for this configuration\r\n - Working and example [roles and profiles](https://docs.puppet.com/pe/latest/puppet_assign_configurations.html#assigning-configuration-data-with-role-and-profile-modules) code\r\n\r\n# How to set it all up\r\n\r\n## Copy this repo into your own Git server\r\n\r\n### GitLab\r\n\r\n1. On a new server, install GitLab\r\n - https://about.gitlab.com/downloads/\r\n\r\n2. After GitLab is installed you may sign into the web UI with the `root` user and password `5iveL!fe`\r\n\r\n3. In the GitLab UI, make a user for yourself\r\n\r\n4. From your laptop or development machine, make an SSH key to link with your user.\r\n - Note: this is used for your laptop to communicate with your GitLab server to push code\r\n - https://help.github.com/articles/generating-ssh-keys/\r\n - http://doc.gitlab.com/ce/ssh/README.html\r\n\r\n5. In the GitLab UI, create a group called `puppet` ( this is case sensitive )\r\n - http://doc.gitlab.com/ce/workflow/groups.html\r\n\r\n7. In the GitLab UI, add your user to the `puppet` group\r\n - Make sure to give your user at least master permissions so you can complete the below steps\r\n - Read more about permissions:\r\n    - https://gitlab.com/gitlab-org/gitlab-ce/blob/master/doc/permissions/permissions.md\r\n\r\n8. In the GitLab UI, create a project called `control-repo` and set its Namespace to the `puppet` group\r\n\r\n10. On your laptop, clone this GitHub control repo\r\n - `git clone <repo URL>`\r\n - `cd control-repo`\r\n\r\n14. On your laptop, remove the origin remote\r\n - `git remote remove origin`\r\n\r\n15. On your laptop, add your internal repo as the origin remote\r\n - `git remote add origin <SSH URL of your GitLab repo>`\r\n\r\n16. On your laptop, push the production branch of the repo from your machine up to your Git server\r\n - `git push origin production`\r\n\r\n### Stash\r\n\r\nComing soon!\r\n\r\n### GitHub\r\n\r\nComing soon!\r\n\r\n## Configure PE to use the control-repo\r\n\r\n### Install PE\r\n\r\n1. Download the latest version of the PE installer for your platform\r\n - https://puppetlabs.com/download-puppet-enterprise\r\n2. SSH into your Puppet master and copy the installer tarball into `/tmp`\r\n2. Expand the tarball and `cd` into the directory\r\n3. Run `puppet-enterprise-installer` to install\r\n\r\nIf you run into any issues or have more questions about the installer you can see our docs here:\r\n\r\nhttp://docs.puppetlabs.com/pe/latest/install_basic.html\r\n\r\n### Get the control-repo deployed on your master\r\n\r\nAt this point you have our control-repo code deployed into your Git server.  However, we have one final challenge: getting that code onto your Puppet master.  In the end state the master will pull code from the Git server via Code Manager, however, at this moment your Puppet master does not have credentials to get code from the Git server.\r\n\r\nWe will set up a deploy key in the Git server that will allow an SSH key we make to deploy the code and configure everything else.\r\n\r\n1. On your Puppet master, make an SSH key for r10k to connect to GitLab\r\n - `/usr/bin/ssh-keygen -t rsa -b 2048 -C 'code_manager' -f /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa -q -N ''`\r\n - `cat /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa.pub`\r\n - References:\r\n    - https://help.github.com/articles/generating-ssh-keys/\r\n    - http://doc.gitlab.com/ce/ssh/README.html\r\n2. In the GitLab UI, create a deploy key on the `control-repo` project\r\n - Paste in the public key from above\r\n3. Login to the PE console\r\n4. Navigate to the **Nodes > Classification** page\r\n - Click on the **PE Master** group\r\n - Click the **Classes** tab\r\n - Add the `puppet_enterprise::profile::master`\r\n    - Set the `r10k_remote` to the SSH URL from the front page of your GitLab repo\r\n    - Set the `r10k_private_key` parameter to `/etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa`\r\n - **Commit** your changes\r\n5. On your Puppet master\r\n - Run:\r\n\r\n    ~~~\r\n    puppet agent -t\r\n    r10k deploy environment -pv\r\n    puppet agent -t\r\n    ~~~\r\n\r\n5. Navigate back to the **Nodes > Classification** page\r\n - Near the top of the page select \"add a group\"\r\n - Type `role::all_in_one_pe` for the group name\r\n    - Click the **Add Group** button\r\n - Click the **add membership rules, classes and variables** link that appears\r\n    - Below **Pin specific nodes to the group** type your master's FQDN into the box\r\n       - Click **pin node**\r\n - Select the **Classes** tab\r\n    - On the right hand side, click the **Refresh** link\r\n       - Wait for this to complete\r\n    - In the **add new classes** box type `role::all_in_one_pe`\r\n       - Click **add class**\r\n - **Commit** your changes\r\n8. On your Puppet master\r\n - Run:\r\n\r\n    ~~~\r\n    puppet agent -t\r\n    echo 'code_manager_mv_old_code=true' > /opt/puppetlabs/facter/facts.d/code_manager_mv_old_code.txt\r\n    puppet agent -t\r\n    ~~~\r\n\r\n9. Code Manager is configured and has been used to deploy your code\r\n\r\n## Setup a webhook in your Git server\r\n\r\nIndependent of which Git server you choose you will grab the webhook URL from your master.  Then each Git Server will have similar but slightly different ways to add the webhook.  \r\n\r\n1. On your Puppet master\r\n - `cat /etc/puppetlabs/puppetserver/.puppetlabs/webhook_url.txt`\r\n\r\n### Gitlab\r\n\r\n2. In your Git server's UI, navigate to the control-repo repository\r\n -  In the left hand pane, scroll to the bottom and select **settings**\r\n - In the left hand pane, select **webhooks**\r\n3. Paste the above webhook URL into the URL field\r\n4. In the trigger section mark the checkbox for **push events** only\r\n3. Disable SSL verification on the webhook\r\n - Since Code Manager uses a self-signed cert from the Puppet CA it is not generally trusted\r\n3. After you created the webhook use \"test webhook\" or similar functionality to confirm it works\r\n\r\n## Test Code Manager\r\n\r\nOne of the components setup by this control-repo is that when you \"push\" code to your Git server, the git server will inform the Puppet master to deploy branch you just pushed.\r\n\r\n1. In one terminal window, `tail -f /var/log/puppetlabs/puppetserver/puppetserver.log`\r\n2. In a second terminal window\r\n - Add a new file, `touch test_file`\r\n - `git add test_file`\r\n - `git commit -m \"adding a test_file\"`\r\n - `git push origin production`\r\n3. Allow the push to complete and then wait a few seconds for everything to sync over\r\n - `ls -l /etc/puppetlabs/code/environments/production`\r\n    - Confirm test_file is present\r\n4. In your first terminal window review the `puppetserver.log` to see the type of logging each sync will create\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}